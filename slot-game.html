<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>åª½ç¥– - Mazu Slot</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      background: radial-gradient(ellipse at center, #2d0a0a 0%, #1a0505 50%, #0d0000 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
      overflow: hidden;
      transition: background 1s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    body.free-mode {
      background: radial-gradient(ellipse at center, #000d2b 0%, #00061a 50%, #000308 100%);
    }
    /* Scale wrapper â€” actual game sits here at 750px, JS scales it to fit */
    #scale-outer {
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #scale-inner {
      width: 750px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transform-origin: top center;
    }
    #game-title {
      font-size: 40px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300;
      letter-spacing: 8px;
      margin-bottom: 8px;
      font-family: 'Microsoft JhengHei', sans-serif;
    }
    #game-container {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 80px rgba(255,80,0,0.4), 0 0 40px rgba(255,215,0,0.3), 0 20px 60px rgba(0,0,0,0.8);
      border: 3px solid rgba(255,215,0,0.5);
    }
    #ui-overlay {
      background: linear-gradient(to top, rgba(10,0,0,0.97) 0%, rgba(20,5,0,0.85) 70%, transparent 100%);
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .info-panel { color: #ffd700; text-align: center; min-width: 70px; }
    .info-panel .label { font-size: 10px; color: #cc8800; text-transform: uppercase; letter-spacing: 2px; }
    .info-panel .value { font-size: 20px; font-weight: bold; text-shadow: 0 0 10px rgba(255,215,0,0.6); }
    #spin-btn {
      width: 96px; height: 96px;
      border-radius: 50%;
      border: 3px solid #ffd700;
      background: radial-gradient(circle at 40% 35%, #ff9900, #cc5500);
      color: #fff; font-size: 14px; font-weight: bold;
      cursor: pointer; transition: all 0.2s ease;
      box-shadow: 0 4px 20px rgba(255,150,0,0.5), 0 0 30px rgba(255,215,0,0.3);
      text-transform: uppercase; letter-spacing: 2px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    #spin-btn:hover:not(:disabled) { transform: scale(1.08); box-shadow: 0 6px 30px rgba(255,150,0,0.7), 0 0 50px rgba(255,215,0,0.5); }
    #spin-btn:active:not(:disabled) { transform: scale(0.95); }
    #spin-btn:disabled { background: radial-gradient(circle, #555, #333); border-color: #555; cursor: not-allowed; box-shadow: none; }
    #buy-free-btn {
      padding: 10px 14px; border-radius: 8px;
      border: 2px solid #ff4400;
      background: linear-gradient(135deg, #8b0000, #cc2200);
      color: #ffd700; font-size: 11px; font-weight: bold;
      cursor: pointer; transition: all 0.2s; text-align: center; line-height: 1.5;
    }
    #buy-free-btn:hover:not(:disabled) { background: linear-gradient(135deg, #cc2200, #ff3300); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(255,80,0,0.5); }
    #buy-free-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .bet-controls { display: flex; gap: 8px; align-items: center; }
    .bet-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ffd700; background: transparent; color: #ffd700; font-size: 18px; cursor: pointer; transition: all 0.2s; line-height: 1; }
    .bet-btn:hover { background: rgba(255,215,0,0.2); }

    /* Free Games Intro */
    #free-intro {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.97); z-index: 1000;
      align-items: center; justify-content: center; flex-direction: column;
    }
    #free-intro.active { display: flex; }
    .intro-icon { font-size: 110px; animation: floatUpDown 0.9s ease-in-out infinite alternate; filter: drop-shadow(0 0 40px gold); }
    @keyframes floatUpDown { from { transform: translateY(-12px) scale(1.0); } to { transform: translateY(12px) scale(1.06); } }
    .intro-title { font-size: 50px; color: #ffd700; font-weight: bold; text-shadow: 0 0 30px #ff6600, 0 0 60px #ff3300; margin: 16px 0 8px; letter-spacing: 6px; }
    .intro-sub { font-size: 18px; color: #ffaa44; letter-spacing: 3px; }
    .intro-counts { font-size: 28px; color: #fff; margin-top: 16px; }

    /* Win overlay */
    #win-overlay {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-weight: bold; color: #ffd700;
      text-shadow: 0 0 20px #ffd700, 0 0 40px #ff6600, 0 0 60px #ff0000;
      opacity: 0; pointer-events: none; z-index: 200; text-align: center; white-space: nowrap;
    }

    /* Buttons touch feedback */
    button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    #spin-btn:active:not(:disabled) { transform: scale(0.92) !important; }

    /* Free counter */
    #free-counter {
      display: none; position: fixed; top: 10px; left: 10px;
      background: rgba(0,5,40,0.95); border: 2px solid #ffd700;
      border-radius: 10px; padding: 6px 12px; color: #ffd700; font-weight: bold;
      font-size: 13px; z-index: 50; text-align: center;
    }
    #free-counter.show { display: block; }

    /* Paytable */
    #pt-btn {
      position: fixed; top: 10px; right: 10px;
      background: rgba(80,0,0,0.9); border: 1px solid #ffd700;
      color: #ffd700; padding: 8px 14px; border-radius: 8px;
      cursor: pointer; font-size: 12px; z-index: 50;
      min-height: 36px; /* touch target */
    }
    #paytable {
      display: none; position: fixed; top: 52px; right: 10px;
      background: rgba(15,0,0,0.97); border: 1px solid #ffd700;
      border-radius: 10px; padding: 12px 16px; color: #fff;
      font-size: 11px; z-index: 50;
      max-width: min(280px, calc(100vw - 20px));
      max-height: calc(100vh - 60px); overflow-y: auto;
    }
    #paytable.show { display: block; }
    #paytable h3 { color: #ffd700; margin-bottom: 10px; text-align: center; font-size: 13px; }
    .pt-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(255,215,0,0.1); gap: 8px; }
    .pt-pays { color: #ffd700; white-space: nowrap; }
    .pt-note { margin-top: 8px; color: #777; font-size: 10px; text-align: center; }

    /* Particles */
    .particle { position: fixed; pointer-events: none; z-index: 999; font-size: 22px; }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      .intro-icon  { font-size: 80px; }
      .intro-title { font-size: 36px; letter-spacing: 4px; }
      .intro-sub   { font-size: 14px; }
      .intro-counts{ font-size: 20px; }
      #paytable    { font-size: 10px; }
    }
  </style>
</head>
<body>

<!-- Free Games Intro -->
<div id="free-intro">
  <div class="intro-icon">ğŸŒº</div>
  <div class="intro-title">åª½ç¥–é™è‡¨</div>
  <div class="intro-sub">ç¥å…‰è­·ä½‘ï¼Œè²¡æºå»£é€²</div>
  <div class="intro-counts">âœ¨ 10 æ¬¡å…è²»éŠæˆ² Ã— 3 å€å½©é‡‘ âœ¨</div>
</div>

<!-- Free counter -->
<div id="free-counter">ğŸ å…è²»éŠæˆ²<br><span id="free-count">10</span> å±€å‰©é¤˜</div>

<!-- Paytable -->
<button id="pt-btn" onclick="document.getElementById('paytable').classList.toggle('show')">ğŸ“‹ è³ ç‡è¡¨</button>
<div id="paytable">
  <h3>ğŸŒº åª½ç¥–è³ ç‡è¡¨ï¼ˆAll Waysï¼‰</h3>
  <div class="pt-row"><span>ğŸ’  åª½ç¥–</span><span class="pt-pays">3Ã—50 | 4Ã—200 | 5Ã—1000</span></div>
  <div class="pt-row"><span>ğŸŒ™ æœˆå¨¥</span><span class="pt-pays">3Ã—20 | 4Ã—80 | 5Ã—400</span></div>
  <div class="pt-row"><span>âš¡ åƒé‡Œçœ¼</span><span class="pt-pays">3Ã—10 | 4Ã—40 | 5Ã—200</span></div>
  <div class="pt-row"><span>ğŸŒŠ é †é¢¨è€³</span><span class="pt-pays">3Ã—8 | 4Ã—30 | 5Ã—150</span></div>
  <div class="pt-row"><span>ğŸ® å®®ç‡ˆ</span><span class="pt-pays">3Ã—5 | 4Ã—20 | 5Ã—80</span></div>
  <div class="pt-row"><span>ğŸ‰ é¾</span><span class="pt-pays">3Ã—3 | 4Ã—12 | 5Ã—50</span></div>
  <div class="pt-row"><span>ğŸŒ¸ è“®èŠ±</span><span class="pt-pays">3Ã—2 | 4Ã—8 | 5Ã—30</span></div>
  <div class="pt-row"><span>ğŸ”± ä¸‰å‰æˆŸ</span><span class="pt-pays">3Ã—1 | 4Ã—4 | 5Ã—15</span></div>
  <div class="pt-row"><span>â™¦ ç¬¦ç‰Œ</span><span class="pt-pays">3Ã—0.5 | 4Ã—1.5 | 5Ã—5</span></div>
  <div class="pt-note">è³ ç‡ Ã— ä¸­çè·¯æ•¸ Ã— æŠ•æ³¨ | RTP â‰ˆ 102%</div>
</div>

<div id="scale-outer"><div id="scale-inner">
<div id="game-title">ğŸŒº åª½ç¥– ğŸŒº</div>
<div id="game-container">
  <canvas id="game-canvas"></canvas>
  <div id="win-overlay"></div>
  <div id="ui-overlay">
    <div class="info-panel">
      <div class="label">é¤˜é¡</div>
      <div class="value" id="balance">1000</div>
    </div>
    <div class="bet-controls">
      <button class="bet-btn" id="bet-down">âˆ’</button>
      <div class="info-panel">
        <div class="label">æŠ•æ³¨</div>
        <div class="value" id="bet-amount">10</div>
      </div>
      <button class="bet-btn" id="bet-up">+</button>
    </div>
    <button id="spin-btn">SPIN</button>
    <div class="info-panel">
      <div class="label">è´å¾—</div>
      <div class="value" id="last-win">0</div>
    </div>
    <button id="buy-free-btn">ğŸ å…è²»éŠæˆ²<br><span id="buy-cost">100Ã—</span></button>
  </div>
</div>
</div></div><!-- /scale-inner /scale-outer -->

<script>
// ============================================================
// RTP â‰ˆ 102% è¨­è¨ˆèªªæ˜
// ç¬¦è™Ÿæ¬Šé‡ (weight): â™¦:15, ğŸ”±:10, ğŸŒ¸:8, ğŸ‰:6, ğŸ®:5, ğŸŒŠ:4, âš¡:3, ğŸŒ™:2, ğŸ’ :1  â†’ ç¸½è¨ˆ 54
// æ¯æ ¼å‡ºç¾æ©Ÿç‡ p_s = weight/54ï¼Œæ¯è½‰è¼ª 6 æ ¼
// Î¼_s = 6 Ã— p_s = æ¯è½‰è¼ªæœŸæœ›å‡ºç¾æ¬¡æ•¸
//
// All Ways æœŸæœ›è´å½© (per bet unit, é€£çºŒå¾ç¬¬1è½‰è¼ªé–‹å§‹):
//   q_s = (1-p_s)^6  â†’ æŸè½‰è¼ªå®Œå…¨æ²’æœ‰ç¬¦è™Ÿsçš„æ©Ÿç‡
//   E[win_3] = Î¼_s^3 Ã— q_s Ã— pays[3]
//   E[win_4] = Î¼_s^4 Ã— q_s Ã— pays[4]
//   E[win_5] = Î¼_s^5 Ã— pays[5]
//   Total RTP = Î£_s (E[win_3] + E[win_4] + E[win_5]) â‰ˆ 1.02
// ============================================================

const CFG = {
  W: 750, H: 570,
  REELS: 5, ROWS: 6,
  SYM_W: 100, SYM_H: 64,
  FREE_COUNT: 10, FREE_MULT: 3,
  BUY_COST_X: 100,
};

// pays[k] = payout multiplier for k consecutive matching reels (per way, per bet unit)
// index: 0=unused, 1=unused, 2=unused, 3=3-match, 4=4-match, 5=5-match
const SYMS = [
  { id:0, e:'ğŸ’ ', n:'åª½ç¥–',  w:1,  pays:[0,0,0, 50,  200, 1000] },
  { id:1, e:'ğŸŒ™', n:'æœˆå¨¥',  w:2,  pays:[0,0,0, 20,  80,  400 ] },
  { id:2, e:'âš¡', n:'åƒé‡Œçœ¼', w:3,  pays:[0,0,0, 10,  40,  200 ] },
  { id:3, e:'ğŸŒŠ', n:'é †é¢¨è€³', w:4,  pays:[0,0,0, 8,   30,  150 ] },
  { id:4, e:'ğŸ®', n:'å®®ç‡ˆ',  w:5,  pays:[0,0,0, 5,   20,  80  ] },
  { id:5, e:'ğŸ‰', n:'é¾',    w:6,  pays:[0,0,0, 3,   12,  50  ] },
  { id:6, e:'ğŸŒ¸', n:'è“®èŠ±',  w:8,  pays:[0,0,0, 2,   8,   30  ] },
  { id:7, e:'ğŸ”±', n:'ä¸‰å‰æˆŸ', w:10, pays:[0,0,0, 1,   4,   15  ] },
  { id:8, e:'â™¦',  n:'ç¬¦ç‰Œ',  w:15, pays:[0,0,0, 0.5, 1.5, 5   ] },
];
const TOTAL_W = SYMS.reduce((s,x)=>s+x.w,0); // 54

function pickSym() {
  let r = Math.random() * TOTAL_W;
  for (const s of SYMS) { r -= s.w; if (r <= 0) return s.id; }
  return SYMS[SYMS.length-1].id;
}

// All-Ways win check
// grid[reel][row] = symbolId
function calcWin(grid, bet) {
  let total = 0;
  const hits = [];
  for (const sym of SYMS) {
    let matchLen = 0, ways = 0;
    for (let r = 0; r < CFG.REELS; r++) {
      const cnt = grid[r].filter(s => s === sym.id).length;
      if (cnt === 0) break;
      matchLen++;
      ways = r === 0 ? cnt : ways * cnt;
    }
    if (matchLen >= 3 && sym.pays[matchLen] > 0) {
      const win = Math.round(ways * sym.pays[matchLen] * bet * 10) / 10;
      total += win;
      hits.push({ sym, matchLen, ways, win });
    }
  }
  return { total: Math.round(total * 10) / 10, hits };
}

// ---- State ----
let balance = 1000;
let betAmt  = 10;
let spinning = false;
let freeLeft = 0;
let freeMode = false;

// ---- PixiJS ----
const app = new PIXI.Application({
  view: document.getElementById('game-canvas'),
  width: CFG.W, height: CFG.H,
  backgroundColor: 0x0e0000, antialias: true
});

const REEL_X0 = (CFG.W - CFG.REELS * CFG.SYM_W) / 2;
const REEL_Y0 = 14;
const FRAME_W = CFG.REELS * CFG.SYM_W;
const FRAME_H = CFG.ROWS  * CFG.SYM_H;

// Background
const bgGfx = new PIXI.Graphics();
bgGfx.beginFill(0x0e0000); bgGfx.drawRect(0,0,CFG.W,CFG.H); bgGfx.endFill();
bgGfx.lineStyle(1, 0xffd700, 0.12);
for (let i=0; i<14; i++) { bgGfx.moveTo(0, i*50); bgGfx.lineTo(CFG.W, i*50+90); }
app.stage.addChild(bgGfx);

// Reels
const reels = [];
for (let r = 0; r < CFG.REELS; r++) {
  const cont = new PIXI.Container();
  cont.x = REEL_X0 + r * CFG.SYM_W + CFG.SYM_W/2;
  cont.y = REEL_Y0;

  const mask = new PIXI.Graphics();
  mask.beginFill(0xffffff);
  mask.drawRect(-CFG.SYM_W/2, 0, CFG.SYM_W, FRAME_H);
  mask.endFill();
  cont.addChild(mask);
  cont.mask = mask;

  const blur = new PIXI.BlurFilter();
  blur.blurX = 0; blur.blurY = 0;
  cont.filters = [blur];

  const syms = [];
  for (let row = 0; row < CFG.ROWS + 3; row++) {
    const sid = pickSym();
    const t = new PIXI.Text(SYMS[sid].e, {
      fontFamily: 'Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, sans-serif',
      fontSize: 42, align: 'center'
    });
    t.anchor.set(0.5, 0.5);
    t.x = 0;
    t.y = row * CFG.SYM_H + CFG.SYM_H / 2;
    t.sid = sid;
    cont.addChild(t);
    syms.push(t);
  }

  app.stage.addChild(cont);
  reels.push({ cont, blur, syms });
}

// Frame (drawn on top of reels)
const frameGfx = new PIXI.Graphics();
// shadow
frameGfx.beginFill(0x000000, 0.6);
frameGfx.drawRoundedRect(REEL_X0-10+5, REEL_Y0-10+5, FRAME_W+20, FRAME_H+20, 12);
frameGfx.endFill();
// body
frameGfx.beginFill(0x1a0000);
frameGfx.lineStyle(3, 0xffd700, 0.9);
frameGfx.drawRoundedRect(REEL_X0-10, REEL_Y0-10, FRAME_W+20, FRAME_H+20, 12);
frameGfx.endFill();
// reel dividers
frameGfx.lineStyle(1, 0xffd700, 0.25);
for (let i=1; i<CFG.REELS; i++) {
  const x = REEL_X0 + i * CFG.SYM_W;
  frameGfx.moveTo(x, REEL_Y0-10); frameGfx.lineTo(x, REEL_Y0+FRAME_H+10);
}
// re-cut inner window (punch out the center so reels show through)
frameGfx.lineStyle(0);
frameGfx.beginFill(0x000000, 0);
frameGfx.drawRect(REEL_X0, REEL_Y0, FRAME_W, FRAME_H);
frameGfx.endFill();
app.stage.addChild(frameGfx);

// ---- Spin ----
async function spin() {
  if (spinning) return;
  if (!freeMode && balance < betAmt) return;
  spinning = true;
  setUIEnabled(false);

  if (!freeMode) { balance -= betAmt; updateUI(); }

  // Decide final grid
  const grid = Array.from({length: CFG.REELS}, () =>
    Array.from({length: CFG.ROWS}, () => pickSym())
  );

  // Animate all reels
  await Promise.all(reels.map((reel, i) =>
    new Promise(res => setTimeout(() => animateReel(reel, i, grid[i]).then(res), i * 160))
  ));

  // Calculate win
  const { total, hits } = calcWin(grid, betAmt);
  const mult = freeMode ? CFG.FREE_MULT : 1;
  const won  = Math.round(total * mult * 10) / 10;

  if (won > 0) {
    balance += won;
    document.getElementById('last-win').textContent = won;
    await showWin(won, betAmt * mult, hits, grid);
  } else {
    document.getElementById('last-win').textContent = '0';
  }

  if (freeMode) {
    freeLeft--;
    document.getElementById('free-count').textContent = freeLeft;
    if (freeLeft <= 0) {
      freeMode = false;
      document.getElementById('free-counter').classList.remove('show');
      document.body.classList.remove('free-mode');
      await endFreeGames();
    }
  }

  updateUI();
  spinning = false;
  setUIEnabled(true);

  if (freeMode && freeLeft > 0) setTimeout(spin, 700);
}

function animateReel(reel, idx, final) {
  return new Promise(resolve => {
    const cycles = 3 + idx;
    let done = 0, pos = 0;
    const WRAP = (CFG.ROWS + 3) * CFG.SYM_H;
    gsap.to(reel.blur, { blurY: 22, duration: 0.14 });

    const tick = () => {
      pos += 28;
      reel.syms.forEach((t, i) => {
        let y = (i * CFG.SYM_H + CFG.SYM_H/2 - pos) % WRAP;
        if (y < 0) y += WRAP;
        t.y = y;
        if (y > FRAME_H + CFG.SYM_H * 0.5) {
          t.sid = pickSym();
          t.text = SYMS[t.sid].e;
        }
      });
      if (pos >= WRAP) {
        pos = 0; done++;
        if (done >= cycles) {
          app.ticker.remove(tick);
          // Place final symbols
          for (let row = 0; row < CFG.ROWS; row++) {
            reel.syms[row].sid  = final[row];
            reel.syms[row].text = SYMS[final[row]].e;
            reel.syms[row].y    = row * CFG.SYM_H + CFG.SYM_H/2;
          }
          gsap.to(reel.blur, { blurY: 0, duration: 0.1 });
          gsap.to(reel.cont, {
            y: reel.cont.y + 9, duration: 0.08, yoyo: true, repeat: 1,
            ease: 'power2.out', onComplete: resolve
          });
        }
      }
    };
    app.ticker.add(tick);
  });
}

// ---- Win Effects ----
async function showWin(won, ref, hits, grid) {
  const el  = document.getElementById('win-overlay');
  const r   = won / ref;
  let label, sz;

  if (r >= 100) { label = `ğŸ’  LEGENDARY WIN!! ğŸ’ \n+${won}`; sz = '38px'; spawnParticles(40); }
  else if (r >= 50) { label = `ğŸŒŸ MEGA WIN!! ğŸŒŸ\n+${won}`;   sz = '44px'; spawnParticles(30); }
  else if (r >= 15) { label = `âœ¨ BIG WIN! âœ¨\n+${won}`;      sz = '48px'; spawnParticles(18); }
  else if (r >= 5)  { label = `ğŸŠ WIN! ğŸŠ\n+${won}`;         sz = '50px'; spawnParticles(8);  }
  else              { label = `+${won}`;                      sz = '46px'; }

  el.style.fontSize = sz;
  el.style.whiteSpace = 'pre';
  el.textContent = label;

  // Flash winning symbols
  hits.forEach(({ sym, matchLen }) => {
    for (let r2 = 0; r2 < matchLen; r2++) {
      reels[r2].syms.forEach(t => {
        if (t.sid === sym.id) {
          gsap.to(t, { alpha: 0.25, duration: 0.09, yoyo: true, repeat: 9 });
          gsap.to(t.scale, { x: 1.15, y: 1.15, duration: 0.12, yoyo: true, repeat: 5 });
        }
      });
    }
  });

  await new Promise(res => {
    gsap.timeline({ onComplete: res })
      .to(el, { opacity:1, scale:1.2, duration:0.28, ease:'back.out(2)' })
      .to(el, { opacity:0, scale:1,   duration:0.45, delay: r>=15?2:r>=5?1.2:0.7, ease:'power2.in' });
  });
}

async function endFreeGames() {
  const el = document.getElementById('win-overlay');
  el.style.fontSize = '38px';
  el.style.whiteSpace = 'pre';
  el.textContent = 'ğŸŒº åª½ç¥–è­·ä½‘ ğŸŒº\nå…è²»éŠæˆ²çµæŸ';
  spawnParticles(20);
  await new Promise(res => {
    gsap.timeline({ onComplete: res })
      .to(el, { opacity:1, scale:1.1, duration:0.4, ease:'back.out' })
      .to(el, { opacity:0, duration:0.5, delay:2.5 });
  });
}

function spawnParticles(n = 15) {
  const pool = ['ğŸ’°','âœ¨','ğŸŒŸ','ğŸ’›','ğŸŠ','ğŸŒº','ğŸª™','ğŸ”¶'];
  for (let i = 0; i < n; i++) {
    const el = document.createElement('div');
    el.className = 'particle';
    el.textContent = pool[Math.floor(Math.random() * pool.length)];
    el.style.left = (Math.random() * 100) + 'vw';
    el.style.top  = '-30px';
    document.body.appendChild(el);
    gsap.to(el, {
      y: window.innerHeight + 60,
      x: (Math.random() - 0.5) * 250,
      rotation: Math.random() * 720,
      duration: 1.4 + Math.random() * 0.8,
      ease: 'power1.in',
      onComplete: () => el.remove()
    });
  }
}

// ---- Free Games ----
async function buyFreeGames() {
  const cost = betAmt * CFG.BUY_COST_X;
  if (spinning || freeMode || balance < cost) return;
  balance -= cost;
  updateUI();

  const intro = document.getElementById('free-intro');
  intro.classList.add('active');
  for (let i = 0; i < 5; i++) setTimeout(() => spawnParticles(12), i * 400);

  await new Promise(r => setTimeout(r, 3000));
  intro.classList.remove('active');

  freeMode = true;
  freeLeft = CFG.FREE_COUNT;
  document.getElementById('free-count').textContent = freeLeft;
  document.getElementById('free-counter').classList.add('show');
  document.body.classList.add('free-mode');

  setTimeout(spin, 500);
}

// ---- UI ----
function updateUI() {
  document.getElementById('balance').textContent = Math.round(balance * 10) / 10;
  document.getElementById('bet-amount').textContent = betAmt;
  const cost = betAmt * CFG.BUY_COST_X;
  document.getElementById('buy-cost').textContent = cost + 'Ã—';
  document.getElementById('buy-free-btn').disabled = (balance < cost || freeMode);
}

function setUIEnabled(on) {
  document.getElementById('spin-btn').disabled    = !on;
  document.getElementById('buy-free-btn').disabled = !on;
  document.getElementById('bet-up').disabled       = !on;
  document.getElementById('bet-down').disabled     = !on;
}

// ---- Events ----
document.getElementById('spin-btn').addEventListener('click', spin);
document.getElementById('buy-free-btn').addEventListener('click', buyFreeGames);
document.getElementById('bet-up').addEventListener('click', () => {
  if (!spinning) { betAmt = Math.min(betAmt + 10, 200); updateUI(); }
});
document.getElementById('bet-down').addEventListener('click', () => {
  if (!spinning) { betAmt = Math.max(betAmt - 10, 10); updateUI(); }
});
document.addEventListener('keydown', e => { if (e.code === 'Space') { e.preventDefault(); spin(); } });

// ---- Mobile Scale ----
function applyScale() {
  const inner = document.getElementById('scale-inner');
  const GAME_W = 750;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  // Scale to fit both width and height
  const scaleW = vw / GAME_W;
  const gameH  = inner.offsetHeight || 720;
  const scaleH = vh / gameH;
  const scale  = Math.min(scaleW, scaleH, 1); // never upscale past 1
  inner.style.transform = `scale(${scale})`;
  // Compensate height so body doesn't overflow
  inner.style.marginTop = `${(gameH * scale - gameH) / 2}px`;
}
window.addEventListener('resize', applyScale);
// Screen orientation change
window.addEventListener('orientationchange', () => setTimeout(applyScale, 300));
applyScale();

updateUI();
console.log('ğŸŒº åª½ç¥– Mazu Slot åˆå§‹åŒ–å®Œæˆï¼5Ã—6 All Ways, RTP â‰ˆ 102%');
</script>
</body>
</html>
